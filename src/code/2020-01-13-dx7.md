---
layout: code.njk
title: Dx7
date: 2020-01-13
published: false
tags:
  - code
html:
  lang: html
  code: |-
    <form id="dx7" name="dx7">
      <label for="algorithm">Algorithm</label>
      <select id="algorithm" name="algorithm">
        <option value="0">0</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
        <option value="19">19</option>
        <option value="20">20</option>
        <option value="21">21</option>
        <option value="22">22</option>
        <option value="23">23</option>
        <option value="24">24</option>
        <option value="25">25</option>
        <option value="26">26</option>
        <option value="27">27</option>
        <option value="28">28</option>
        <option value="29">29</option>
        <option value="30">30</option>
        <option value="31">31</option>
      </select>
      <fieldset id="operators-0">
        <legend>Operator 0</legend>
        <label for="operators-0-volume">Gain</label>
        <input id="operators-0-volume" name="operators-0-volume" type="range" max="1" step="0.01"/>
        <label for="operators-0-harmonicity">Harmonicity</label>
        <input id="operators-0-harmonicity" name="operators-0-harmonicity" type="range" max="99"/>
        <!-- mode -->
        <!-- freq -->
        <!-- detune -->
        <label for="operators-0-envelope-attack">Attack</label>
        <input id="operators-0-envelope-attack" name="operators-0-envelope-attack" type="range" max="1" step="0.01"/>
        <label for="operators-0-envelope-decay">Decay</label>
        <input id="operators-0-envelope-decay" name="operators-0-envelope-decay" type="range" max="1" step="0.01"/>
        <label for="operators-0-envelope-sustain">Sustain</label>
        <input id="operators-0-envelope-sustain" name="operators-0-envelope-sustain" type="range" max="1" step="0.01"/>
        <label for="operators-0-envelope-release">Release</label>
        <input id="operators-0-envelope-release" name="operators-0-envelope-release" type="range" max="1" step="0.01"/>
      </fieldset>
      <fieldset id="operators-1">
        <legend>Operator 1</legend>
        <label for="operators-1-volume">Gain</label>
        <input id="operators-1-volume" name="operators-1-volume" type="range" max="1" step="0.01"/>
        <label for="operators-1-harmonicity">Harmonicity</label>
        <input id="operators-1-harmonicity" name="operators-1-harmonicity" type="range" max="99"/>
        <!-- mode -->
        <!-- freq -->
        <!-- detune -->
        <label for="operators-1-envelope-attack">Attack</label>
        <input id="operators-1-envelope-attack" name="operators-1-envelope-attack" type="range" max="1" step="0.01"/>
        <label for="operators-1-envelope-decay">Decay</label>
        <input id="operators-1-envelope-decay" name="operators-1-envelope-decay" type="range" max="1" step="0.01"/>
        <label for="operators-1-envelope-sustain">Sustain</label>
        <input id="operators-1-envelope-sustain" name="operators-1-envelope-sustain" type="range" max="1" step="0.01"/>
        <label for="operators-1-envelope-release">Release</label>
        <input id="operators-1-envelope-release" name="operators-1-envelope-release" type="range" max="1" step="0.01"/>
      </fieldset>
      <fieldset id="operators-2">
        <legend>Operator 2</legend>
        <label for="operators-2-volume">Gain</label>
        <input id="operators-2-volume" name="operators-2-volume" type="range" max="1" step="0.01"/>
        <label for="operators-2-harmonicity">Harmonicity</label>
        <input id="operators-2-harmonicity" name="operators-2-harmonicity" type="range" max="99"/>
        <!-- mode -->
        <!-- freq -->
        <!-- detune -->
        <label for="operators-2-envelope-attack">Attack</label>
        <input id="operators-2-envelope-attack" name="operators-2-envelope-attack" type="range" max="1" step="0.01"/>
        <label for="operators-2-envelope-decay">Decay</label>
        <input id="operators-2-envelope-decay" name="operators-2-envelope-decay" type="range" max="1" step="0.01"/>
        <label for="operators-2-envelope-sustain">Sustain</label>
        <input id="operators-2-envelope-sustain" name="operators-2-envelope-sustain" type="range" max="1" step="0.01"/>
        <label for="operators-2-envelope-release">Release</label>
        <input id="operators-2-envelope-release" name="operators-2-envelope-release" type="range" max="1" step="0.01"/>
      </fieldset>
      <fieldset id="operators-3">
        <legend>Operator 3</legend>
        <label for="operators-3-volume">Gain</label>
        <input id="operators-3-volume" name="operators-3-volume" type="range" max="1" step="0.01"/>
        <label for="operators-3-harmonicity">Harmonicity</label>
        <input id="operators-3-harmonicity" name="operators-3-harmonicity" type="range" max="99"/>
        <!-- mode -->
        <!-- freq -->
        <!-- detune -->
        <label for="operators-3-envelope-attack">Attack</label>
        <input id="operators-3-envelope-attack" name="operators-3-envelope-attack" type="range" max="1" step="0.01"/>
        <label for="operators-3-envelope-decay">Decay</label>
        <input id="operators-3-envelope-decay" name="operators-3-envelope-decay" type="range" max="1" step="0.01"/>
        <label for="operators-3-envelope-sustain">Sustain</label>
        <input id="operators-3-envelope-sustain" name="operators-3-envelope-sustain" type="range" max="1" step="0.01"/>
        <label for="operators-3-envelope-release">Release</label>
        <input id="operators-3-envelope-release" name="operators-3-envelope-release" type="range" max="1" step="0.01"/>
      </fieldset>
      <fieldset id="operators-4">
        <legend>Operator 4</legend>
        <label for="operators-4-volume">Gain</label>
        <input id="operators-4-volume" name="operators-4-volume" type="range" max="1" step="0.01"/>
        <label for="operators-4-harmonicity">Harmonicity</label>
        <input id="operators-4-harmonicity" name="operators-4-harmonicity" type="range" max="99"/>
        <!-- mode -->
        <!-- freq -->
        <!-- detune -->
        <label for="operators-4-envelope-attack">Attack</label>
        <input id="operators-4-envelope-attack" name="operators-4-envelope-attack" type="range" max="1" step="0.01"/>
        <label for="operators-4-envelope-decay">Decay</label>
        <input id="operators-4-envelope-decay" name="operators-4-envelope-decay" type="range" max="1" step="0.01"/>
        <label for="operators-4-envelope-sustain">Sustain</label>
        <input id="operators-4-envelope-sustain" name="operators-4-envelope-sustain" type="range" max="1" step="0.01"/>
        <label for="operators-4-envelope-release">Release</label>
        <input id="operators-4-envelope-release" name="operators-4-envelope-release" type="range" max="1" step="0.01"/>
      </fieldset>
      <fieldset id="operators-5">
        <legend>Operator 5</legend>
        <label for="operators-5-volume">Gain</label>
        <input id="operators-5-volume" name="operators-5-volume" type="range" max="1" step="0.01"/>
        <label for="operators-5-harmonicity">Harmonicity</label>
        <input id="operators-5-harmonicity" name="operators-5-harmonicity" type="range" max="99"/>
        <!-- mode -->
        <!-- freq -->
        <!-- detune -->
        <label for="operators-5-envelope-attack">Attack</label>
        <input id="operators-5-envelope-attack" name="operators-5-envelope-attack" type="range" max="1" step="0.01"/>
        <label for="operators-5-envelope-decay">Decay</label>
        <input id="operators-5-envelope-decay" name="operators-5-envelope-decay" type="range" max="1" step="0.01"/>
        <label for="operators-5-envelope-sustain">Sustain</label>
        <input id="operators-5-envelope-sustain" name="operators-5-envelope-sustain" type="range" max="1" step="0.01"/>
        <label for="operators-5-envelope-release">Release</label>
        <input id="operators-5-envelope-release" name="operators-5-envelope-release" type="range" max="1" step="0.01"/>
      </fieldset>
    </form>
css:
  lang: css
  code: |-
    @import url("https://cdnjs.cloudflare.com/ajax/libs/basscss/8.1.0/css/basscss.min.css");
js:
  lang: javascript
  code: |-
    //import { optionsFromArguments, Gain, Monophonic, Multiply, Signal, Synth } from 'https://cdn.skypack.dev/tone';
    import * as pkg from 'https://cdn.skypack.dev/tone';
    console.log(pkg);

    class DxOperator extends Synth {
      static getDefaults() {
        return {
          ...Synth.getDefaults(),
          harmonicity: 1,
          modulationIndex: 1,
          oscillator: {
            type: 'sine',
          }
        };
      }
    
      constructor() {
        super(optionsFromArguments(DxOperator.getDefaults(), arguments));
        const options = optionsFromArguments(DxOperator.getDefaults(), arguments);
        
        // Undo super();
        this._writable(["frequency"]);
        //this.oscillator.disconnect();
        this.envelope.disconnect();
        
        // Borrow from FMSynth
        this.frequency = new Signal(440, Frequency);
    
        this.harmonicity = new Multiply({ ...options.harmonicity, units: 'positive' });
        
        this.modulationIndex = new Multiply({ ...options.modulationIndex, units: 'positive' });
        
        this._modulationNode = new Gain(0);
        
        this.frequency.chain(this.harmonicity, this.oscillator.frequency);
        this.frequency.chain(this.modulationIndex, this._modulationNode);
        this.envelope.connect(this._modulationNode.gain);
        this._modulationNode.connect(this.output);
        this._readOnly(["frequency", "harmonicity", "modulationIndex"]);
      }
      
      dispose() {
        super.dispose();
        this._writable(['harmonicity', 'modulationIndex']);
        this.frequency.dispose();
        this.frequency = null;
        this.modulationIndex.dispose();
        this.modulationIndex = null;
        this.harmonicity.dispose();
        this.harmonicity = null;
        this._modulationNode.dispose();
        this._modulationNode = null;
        return this;
      }
    }

    class DxSynth extends Monophonic {
      static getDefaults() {
        return {
          algorithm: 0,
          //operators: []
        }
      }

      constructor(options) {
        options = Tone.defaultArg(options, DxSynth.defaults);
        super(options);
        //this.operators = Array.from(new Array(6), (_, i) => new DxOperator(options.operators[i]));
        this.operators = Array.from(new Array(6), (_, i) => new DxOperator());
        this.algorithm = options.algorithm;
        this.frequency = new Tone.Signal(440, Tone.Type.Frequency);
        // Operator 1 is always a carrier
        this.envelope = this.operators[0].envelope;
        
        this.operators.forEach(op => {
          this.frequency.connect(op.frequency);
          op.connect(this.output);
        });
        
        this._readOnly(['frequency']);
      }
      
      get algorithm() {
        return this._algorithm;
      }
      
      set algorithm(value) {
        const v = parseInt(value, 10);
        
        if (v !== this._algorithm && v >= 0 && v <= 31) {
          this._algorithm = value;
          this._setAlgorithm();
        }
      }
      
      /*get(params) {
        const val = super.get(params);
    
        if ('operators' in val) {
          // Not very flexible
          const ops = val['operators'].map(op => op.get());
          val['operators'] = ops;
        }
        
        return val;
      }*/
      
      _triggerEnvelopeAttack(...args) {
        this.operators.forEach(op => op._triggerEnvelopeAttack(...args));
        return this;
      }
      
      _triggerEnvelopeRelease(...args) {
        this.operators.forEach(op => op._triggerEnvelopeRelease(...args));
        return this;
      }
      
      _setAlgorithm() {
        this.operators.forEach(op => op.disconnect());
        
        switch (this.algorithm) {
          case 0: {
            //(op2 : op1),(op6~*(feedback*.2) : op5 : op4 : op3);
            this.operators[1].connect(this.operators[0].frequency);
            this.operators[0].connect(this.output);
            // TODO feedback
            this.operators[5].connect(this.operators[4].frequency);
            this.operators[4].connect(this.operators[3].frequency);
            this.operators[3].connect(this.operators[2].frequency);
            this.operators[2].connect(this.output);
            break;
          }
          default: {
            console.warn(`Unhandled algorithm: ${this.algorithm}`);
          }
        }
      }
      
      dispose() {
        super.dispose();
        this._writable(['frequency']);
        this.operators.forEach(op => op.dispose());
        this.operators = null;    
        return this;
      }
    }


    /**
     * App
     */

    const synth = new Tone.PolySynth(16, DxSynth).toDestination();

    const root = document.querySelector('form');

    // Set the default form values
    for (let [name] of new FormData(root)) {
      const keys = name.split('-');
      let value = keys.reduce((acc, cur) => acc[cur], synth.get(keys.join('.')));
      
      if (name.endsWith('-volume')) {
        value = Tone.dbToGain(value);
      }

      root.querySelector(`[name="${name}"]`).value = value;
    }

    document.addEventListener('change', e => {
      const key = e.target.id.split('-').join('.');
      let value = +e.target.value;
      
      if (key.endsWith('.volume')) {
        value = Tone.gainToDb(value);
      }

      synth.set(key, value);
    });

    function triggerAttackRelease(state, keyCode) {
      const freqs = new Map([
        [65, 220], // a
        [83, 440], // s
      ]);
      
      if (!freqs.has(keyCode)) return;
      
      const freq = freqs.get(keyCode);
      
      if (state) {
        synth.triggerAttack(freq);
      } else {
        synth.triggerRelease(freq);
      }
    }

    document.addEventListener('keydown', e => {
      e.preventDefault();
      if (e.repeat) return;
      triggerAttackRelease(true, e.keyCode);
    });

    document.addEventListener('keyup', e => {
      e.preventDefault();
      triggerAttackRelease(false, e.keyCode);
    });
---
A Dx7 clone using Tone.js.
